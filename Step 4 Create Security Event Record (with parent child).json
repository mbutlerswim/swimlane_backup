{
    "modifiedByUser": {
        "$type": "Core.Models.Utilities.UserGroupSelection, Core", 
        "id": "58c07aedb104880f5094ac59", 
        "name": "admin"
    }, 
    "name": "Step 4 Create Security Event Record (with parent/child)", 
    "triggers": [], 
    "$type": "Core.Models.Integrations.Task, Core", 
    "createdDate": "2017-01-19T18:42:39.98Z", 
    "disabled": false, 
    "createdByUser": {
        "$type": "Core.Models.Utilities.UserGroupSelection, Core", 
        "id": "58c07aedb104880f5094ac59", 
        "name": "admin"
    }, 
    "modifiedDate": "2017-09-12T18:04:25.082Z", 
    "outputs": [
        {
            "$type": "Core.Models.Integrations.Outputs.SetFieldValueOutput, Core", 
            "type": "setFieldValue", 
            "mappings": [
                {
                    "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
                    "type": "outputParameter", 
                    "value": "ajcdc", 
                    "key": "url_parent_record", 
                    "addMissing": false
                }, 
                {
                    "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
                    "type": "outputParameter", 
                    "value": "ao3q9", 
                    "key": "python_output", 
                    "addMissing": false
                }, 
                {
                    "addMissing": false, 
                    "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
                    "value": "ao3yn", 
                    "dataFormat": "Standard", 
                    "key": "se_creation_dt", 
                    "type": "outputParameter"
                }, 
                {
                    "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
                    "type": "outputParameter", 
                    "value": "ayx56", 
                    "key": "show_se_button", 
                    "addMissing": false
                }
            ]
        }
    ], 
    "action": {
        "$type": "Core.Models.Integrations.Actions.Python.PythonAction, Core", 
        "readonly": false, 
        "type": "python", 
        "descriptor": {
            "availableOutputTypes": [
                "insertUpdateRecord", 
                "email", 
                "referentialTask", 
                "saveToFile", 
                "setFieldValue"
            ], 
            "description": "Execute Python scripts", 
            "family": "Scripts", 
            "$type": "Core.Models.Integrations.Actions.AvailableActionDescriptor, Core", 
            "name": "Python", 
            "disabled": false, 
            "readonly": false, 
            "actionType": "python", 
            "inputParameters": {
                "$type": "System.Collections.Generic.Dictionary`2[[System.String, mscorlib],[Core.Models.Integrations.Descriptors.Descriptor, Core]], mscorlib"
            }, 
            "id": "a5Y5Cnj1_0Z9eb3xa", 
            "base64Image": "data:image/png;base64,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"
        }, 
        "script": "# Application Name: Alarms\n# Integration Name: Step 4 Create Security Event Record(with parent/child)\n# Swimlane Version: 2.14 Patch 3\n# Global Integration: On\n#\n##############################################################################################################\n#\n# Validation Date                Validator                Pass/Fail             Comments\n# ###############                ###################      ##################    ##############################\n# 04/13/17  11:40 CDT\t\t\t Joel Laufer\t\t\t  Pass\n#\n#\n##############################################################################################################\n# Modificaitons\n##############################################################################################################\n#\n# Date Time Modified            Reason Modified             Developer\n# ######################        #####################       ############\n# 03/13/17 11:40 CDT            Added Comments Section      Joel Laufer\n# 03/16/17 06:41 CDT    \t\tAdded logical switch        Joel Laufer\n#                               for turning on/off\n#                               Search Engine Functions\n# 03/16/17\t\t\t\t\t    Added Benchmark Time        Mark\n# 03/16/17\t\t\t\t\t\tAdded Task Template \t    Brian & Joel\n# 03/20/17 14:45 CDT\t\t    Added API logic to          Joel Laufer\n#                               handle empty API keys.\n#\n# 03/24/17 10:55 CDT\t\t    Added action and \t\t    Joel Laufer\n#                               category to SE record.\n#\n# 03/27/17 07:02 CDT\t\t\tAdded check_failed_job      Joel Laufer\n#                               to validate failed jobs\n#                               in swimlane Monitoring\n#\n# 04/03/17 16:49 CDT\t\t\tAdded SQL Server Logging    Joel Laufer\n# 04/10/17 8:21 central         Added Global Methods        Joel Laufer\n#                               and sql logging.\n##############################################################################################################\n'''\n##############################################################################################################\n#   Inputs\n##############################################################################################################\n\nVariable                     Type                          Field                    Value\n################             ###############               ###############          ###############################\nsiemid                       Record                        SIEMID\nsignature_id                 Record                        SIEM_Rule_ID\nsip                          Record                        SrcIP\ndip                          Record                        DstIP\nsport                        Record                        SrcPort\ndport                        Record                        DstPort\nsgeo                         Record                        ASN_GeoIP_Src\ndgeo                         Record                        ASN_GeoIP_Dst\nlog_source_name              Record                        Log_Source_Name\nsiem_rule_name               Record                        SIEM_Rule_Name\ncustomer_name                Record                        Customer Name\ntimeprofile_switch\t\t\t Static\t\t\t\t\t\t   \t\t\t\t\t\t    'Off'\nSearch_Engine_Switch\t\t Static\t\t\t\t\t\t\t\t\t\t\t\t\t'Off'\naction\t\t\t\t\t\t Record\t\t\t\t\t\t   Action_Name\ncategory\t\t\t\t\t Record\t\t\t\t\t\t   Category\ncheck_failed_job\t\t\t Static\t\t\t\t\t\t\t\t\t\t\t\t    'Off'\nalarm_id\t\t\t\t\t Record\t\t\t\t\t\t   Tracking ID\n##############################################################################################################\n#   Outputs\n##############################################################################################################\n\nParameter                    Type                          Field                        Value\n################             ###############               ###################          ###############################\nurl_parent_record            Output Parameter              Security Event Link\npython_output                Output Parameter              Python Output\n\n\n'''\n\n##############################################################################################################\n# Python Coding Starts Here\n##############################################################################################################\nimport datetime\nimport time\n\nimport os\nimport sys\nsys.path.append(os.path.abspath(\"e:/SwimlaneConfigs/\"))\nfrom Global_Int_Var import *\nconnect_to_swimlane(sw_context.inputs['apiuser_user'],sw_context.inputs['apiuser_credential'])\n\nglobal host\nhost='s01-portal-01.mss.leidos.com'\n\nprg_name = 'Step 4 Create Security Event Record(with parent/child)'\n\nSearch_Engine_Switch = sw_context.inputs['Search_Engine_Switch']\ncustomer_name = sw_context.inputs['customer_name']\naction_name = sw_context.inputs['action_name']\nalarm_id = sw_context.inputs['alarm_id']\n# Search_Engine_Switch = 'Off' # 'On'\n# timeprofile_switch!='Off'\nglobal s\ns = datetime.datetime.now()\n\n\nglobal u_name\nu_name = sw_context.user[\"display_name\"]\n\n# timeprofile_switch=sw_context.inputs['timeprofile_switch']\ntimeprofile_switch = Timing_Profile_Mode\n\n'''\nfrom swimlane.core.resources import App, Record, Report, User, Group\nfrom swimlane.core.search import Search, filtering\nfrom swimlane.core.search.filtering import create_filter, EQ, CONTAINS, NOT_EQ\nfrom swimlane.core.auth import Client\nimport requests  # needs pip install\nimport urllib  # needs pip install\nimport pytz  # needs pip install\nimport iso8601  # needs pip install\n\n\n\n# Search Engine imports\nfrom SE_API_PROFILE import API_DICT\nimport datetime\nfrom bs4 import BeautifulSoup\nimport re\nimport lxml.etree as ET\nimport time\n'''\n\n\nclass Context:\n    def __init__(self):\n        self.inputs = {}\n        self.asset = {}\n\n\nf = open(Debugging_File_Path + \"profile_4a_create_security_event.txt\", \"a\")\nfs = open(Debugging_File_Path + \"step_4a_log.txt\", \"w+\")\nfs.write('Timing Profile: ' + timeprofile_switch + '\\n')\nfs.write(sw_context.inputs['alarm_id'] + '\\n')\nfs_log = open(Debugging_File_Path + \"test21a.txt\", \"w\")\nfs_log1 = open(Debugging_File_Path + \"Step4a_Error_Log.txt\", \"a\")\n# fs.write('test\\n')\n\n\nif sw_context.inputs['se_generate'] == 'False':\n    Create_Error_Log_Entry('Step 4 Create Security Event Record(with parent/child)', \\\n                           '115', \\\n                           'Initiation', \\\n                           'N', \\\n                           'Security Event Generation Turned Off', \\\n                           '00:00:00', \\\n                           sw_context.inputs['alarm_id'], \\\n                           sw_context.inputs['full_message'], \\\n                           sw_context.inputs['action_name'], \\\n                           fs, \\\n                           sw_context.inputs['customer_name'], \\\n                           '', \\\n                           sw_context.inputs['siem_rule_name'], \\\n                           '0')\n    exit()\n\n\ndef py_charm():\n    if sw_context.inputs['charm_flag'] == 'On':\n        fs_charm = open('e:/SwimlaneConfigs/step4_charm.txt', 'w')\n        fs_charm.write(\"sw_context_inputs={'siemid':'\" + sw_context.inputs['siemid'] + \"',\" + '\\n' + \\\n                       \"'signature_id':'\" + sw_context.inputs['signature_id'] + \"',\" + '\\n' + \\\n                       \"'sip':'\" + sw_context.inputs['sip'] + \"',\" + '\\n' + \\\n                       \"'dip':'\" + sw_context.inputs['dip'] + \"',\" + '\\n' + \\\n                       \"'sport':'\" + sw_context.inputs['sport'] + \"',\" + '\\n' + \\\n                       \"'dport':'\" + sw_context.inputs['dport'] + \"',\" + '\\n' + \\\n                       \"'sgeo':'\" + sw_context.inputs['sgeo'] + \"',\" + '\\n' + \\\n                       \"'dgeo':'\" + sw_context.inputs['dgeo'] + \"',\" + '\\n' + \\\n                       \"'log_source_name':'\" + sw_context.inputs['log_source_name'] + \"',\" + '\\n' + \\\n                       \"'siem_rule_name':'\" + sw_context.inputs['siem_rule_name'] + \"',\" + '\\n' + \\\n                       \"'customer_name':'\" + sw_context.inputs['customer_name'] + \"',\" + '\\n' + \\\n                       \"'timeprofile_switch':'\" + sw_context.inputs['timeprofile_switch'] + \"',\" + '\\n' + \\\n                       \"'Search_Engine_Switch':'\" + sw_context.inputs['Search_Engine_Switch'] + \"',\" + '\\n' + \\\n                       \"'action_name':'\" + sw_context.inputs['action_name'] + \"',\" + '\\n' + \\\n                       \"'device_action':'\" + sw_context.inputs['device_action'] + \"',\" + '\\n' + \\\n                       \"'category':'\" + sw_context.inputs['category'] + \"',\" + '\\n' + \\\n                       \"'check_failed_job':'\" + sw_context.inputs['check_failed_job'] + \"',\" + '\\n' + \\\n                       \"'alarm_id':'\" + sw_context.inputs['alarm_id'] + \"',\" + '\\n' + \\\n                       \"'apiuser_user':'\" + sw_context.inputs['apiuser_user'] + \"',\" + '\\n' + \\\n                       \"'apiuser_credential':'\" + sw_context.inputs['apiuser_credential'] + \"',\" + '\\n' + \\\n                       \"'charm_flag':'\" + sw_context.inputs['charm_flag'] + \"',\" + '\\n' + \\\n                       \"'se_generate':'\" + sw_context.inputs['se_generate'] + \"',\" + '\\n' + \\\n                       \"'alarm_date':'\" + sw_context.inputs['alarm_date'] + \"'}\" + '\\n')\n        fs_charm.write(\"sw_context_config={'RecordId'':'\" + sw_context.config[\"RecordId\"] + \"'}\" + '\\n')\n\n        fs_charm.close()\n    else:\n        pass\n\n\nif timeprofile_switch == 'On':\n    f = open(Debugging_File_Path + \"profile_4_create_security_event.txt\", \"a\")\n    START_TIME = datetime.datetime.now()\n    f.write(\"\\r\\n[{}] START\".format(datetime.datetime.now()))\n\nglobal current_alarm_recordid    \ncurrent_alarm_recordid = sw_context.config[\"RecordId\"]\n\ntest_val = \"test\"\ncheck_failed_job = sw_context.inputs['check_failed_job']\n\n# Search Engine Variables\n# Temp until App is created.\n###########################\nIdentifier = 'api1000'\n\n''' \ntoday\nrequests.packages.urllib3.disable_warnings()\nhome_url = 'https://{}'.format(host)\nClient.set_default(home_url, apiuser, apipassword, verify_ssl=False)\n'''\n\nformat1 = '%m_%d_%Y_%H_%M_%S_'\nformat2 = '%m/%d/%Y %H:%M:%S'\nformat3 = '%Y-%m-%d'\nformat4 = '%Y-%m-%dT%H:%M:%SZ'\nd = datetime.datetime.utcnow()\ndate1 = d.strftime(format2)\ndate_compare = d.strftime(format3)  # + ' UTC'\ndate_to_update = d.strftime(format4)\ndefault_template_name = 'Default Tier 1 Investigation'\n# fs = open(\"c:/test/test21.txt\", \"w\")\nfs_log.write('Line 141 Customer Name:' + sw_context.inputs['customer_name'] + '\\n')\n\n\ndef rest1(customer_name, app_id, record_id, fs):\n    try:\n        # fs=open('C:/test/restrict.txt','w')\n        # The application that you want to restrict records\n        GROUP_FIELD_NAME = customer_name  # sw_context.inputs[\"GROUPFIELDNAME\"] #Group field that holds the group to restrict records\n        ADMIN_GROUP_NAME = \"SL-Admins\"  # the admin group that will have access to all records\n        MSS_GROUP_NAME = \"SL-MSS\"\n        record = Record.find(app_id, record_id)\n        group = next(Group.find(name=GROUP_FIELD_NAME))\n        admin_group = next(Group.find(name=ADMIN_GROUP_NAME))\n        mss_group = next(Group.find(name=MSS_GROUP_NAME))\n\n        fs.write('group:' + str(GROUP_FIELD_NAME) + '\\tGroupID:' + str(group) + '\\n')\n        record.restrict(group, mss_group, admin_group)\n        # record.save()\n    except Exception as e:\n        fs.write('Error occurred:' + str(e) + '\\n')\n\n\ndef find_app_id(applicationname):\n    app = App.find(name=applicationname)\n    return (app.id)\n\n\ndef find_template_id(criteria):\n    try:\n        function_name = 'find_template_id'\n        users = User.find(name=sw_context.inputs['apiuser_user'])\n        for i in users:\n            user_id = i.id\n        CustomerIDAPP = \"Task Template\"\n        app = App.find(name=CustomerIDAPP)\n        app_id = app.id\n        report = Report.new_for(app_id, user_id, \"Task Template Search\")\n        Name = app.field_id(\"Name\")\n        task = app.field_id(\"Task\")\n        report.pageSize = 100\n        default_report_name = 'Default Tier 1 Investigation'\n        # report.filters = [create_filter(Name, EQ, default_report_name)]  or [create_filter(Name, CONTAINS, criteria) ]\n        report.filters = [create_filter(Name, CONTAINS, criteria)]\n        search = Search(report)\n        result = search.execute()\n        if result.count > 0:\n            task_summary = ''\n            default_task = ''\n            other_tasks = ''\n            r = result.records\n            for i in r:\n                master_record_id = i.id\n\n            return (master_record_id)\n        else:\n            return ('None')\n    except Exception as e:\n        ln_nbr = '318'\n        TOTAL_TIME = (datetime.datetime.now() - s)\n        # Create_Error_Log_Entry(ln_nbr,function_name,'Y',str(e),str(TOTAL_TIME).split('.')[0])\n        message = 'Line 321 Error creating Report Template: ' + str(e) + '\\n'\n        fs.write(message)\n        fs_log.write(message)\n\n\ndef api_tb(Command, search_engine1, criteria):\n    # api_tb(action,field,value)\n    # print 'Search_Records: ' + Command + ' ' + search_engine1 + ' ' + criteria + '\\n'\n    try:\n        function_name = 'api_tb'\n        daily_balance = 0\n        malwares_max_daily_bal = 50\n        VirusTotal_Max_Daily_Bal = 5760\n\n        if search_engine1 == 'Malware':\n            max_daily_bal = malwares_max_daily_bal\n        elif search_engine1 == 'VirusTotal':\n            max_daily_bal = VirusTotal_Max_Daily_Bal\n        #############################################################\n        # DailyUpdates for Malware Counts, Max API Key, Total Balance\n        #############################################################\n        list1 = ['BAL', 'APILookup']\n        if Command in list1:\n            users = User.find(name=sw_context.user[\"display_name\"])\n            for i in users:\n                user_id = i.id\n            CustomerIDAPP = \"Search Engine User API\"\n            app = App.find(name=CustomerIDAPP)\n            app_id = app.id\n            report = Report.new_for(app_id, user_id, \"Parent Search Engine User API Records\")\n            API = app.field_id(\"API\")\n            SearchEngine = app.field_id(\"Search Engine\")\n            API_Balance = app.field_id(\"API Balance\")\n            DT_API_BAL_Updated = app.field_id('Date API Last Updated')\n            report.pageSize = 100\n            Search_Engine_Value = GetValueListValueId(app, \"Search Engine\", search_engine1)\n            report.filters = [create_filter(SearchEngine, EQ, Search_Engine_Value), create_filter(API, NOT_EQ, \"\")]\n            search = Search(report)\n            result = search.execute()\n            if result.count > 0:\n                max_api = ''\n                orig_max_api_balance = 0\n                r = result.records\n                for i in r:\n                    master_record_id = i.id\n                    Engine_App = App.find(name=CustomerIDAPP)\n                    Engine_App_id = Engine_App.id\n                    Engine_record = Record.find(Engine_App_id, master_record_id)\n\n                    t_field_ID = Engine_App.field_id(\"Tracking Id\")\n                    tracking_id = Engine_record.values[t_field_ID]\n\n                    API = Engine_App.field_id(\"API\")\n                    apikey = Engine_record.values[API]\n\n                    api_bal = Engine_App.field_id(\"API Balance\")\n                    bal = Engine_record.values[api_bal]\n\n                    search_eng = Engine_App.field_id(\"Search Engine\")\n                    searchengine = Engine_record.values[search_eng]['value']\n\n                    dt_updt = Engine_App.field_id(\"Date API Last Updated\")\n                    dt_last_updated = Engine_record.values[dt_updt]\n\n                    if dt_last_updated[0:10] != date_compare:\n                        Engine_record.values[dt_updt] = date_to_update\n                        Engine_record.values[api_bal] = max_daily_bal\n                        daily_balance = max_daily_bal + daily_balance\n                        new_api_bal = max_daily_bal\n                        Engine_record.update()\n                    else:\n                        daily_balance = bal + daily_balance\n                        new_api_bal = bal\n                    if new_api_bal > orig_max_api_balance:\n                        max_api = apikey\n                        orig_max_api_balance = new_api_bal  # print str(x) + ' ' + str(tracking_id) + ' ' + str(apikey) + ' ' +  str(searchengine) + ' ' + str(date_to_update) + '\\n'\n\n                    while search.has_more_pages:\n                        result = search.next_page()\n                        r = result.records\n                        for i in r:\n                            master_record_id = i.id\n\n                            Engine_App = App.find(name=CustomerIDAPP)\n                            Engine_App_id = Engine_App.id\n                            Engine_record = Record.find(Engine_App_id, master_record_id)\n\n                            t_field_ID = Engine_App.field_id(\"Tracking Id\")\n                            tracking_id = Engine_record.values[t_field_ID]\n\n                            API = Engine_App.field_id(\"API\")\n                            apikey = Engine_record.values[API]\n\n                            api_bal = Engine_App.field_id(\"API Balance\")\n                            bal = Engine_record.values[api_bal]\n                            daily_balance = bal + daily_balance\n\n                            search_eng = Engine_App.field_id(\"Search Engine\")\n                            searchengine = Engine_record.values[search_eng]['value']\n\n                            dt_updt = Engine_App.field_id(\"Date API Last Updated\")\n                            dt_last_updated = Engine_record.values[dt_updt]\n                            if dt_last_updated[0:10] != date_compare:\n                                Engine_record.values[dt_updt] = date_to_update\n                                Engine_record.values[api_bal] = max_daily_bal\n                                daily_balance = max_daily_bal + daily_balance\n                                Engine_record.update()\n                            else:\n                                daily_balance = bal + daily_balance\n                                new_api_bal = bal\n\n                            if new_api_bal > orig_max_api_balance:\n                                max_api = apikey\n                                orig_max_api_balance = new_api_bal\n        if Command == 'BAL':\n            # fs.write('Line 259 api_tb Bal is: ' + str(daily_balance) + '\\n')\n            return (daily_balance)\n\n        elif Command == 'APILookup':\n            # fs.write('line 263 api_tb max_api is: ' + str(max_api) + '\\n')\n            return (max_api)\n\n    except Exception as e:\n        # fs_result.write('except try statement')\n        ln_nbr = '445'\n        TOTAL_TIME = (datetime.datetime.now() - s)\n        # Create_Error_Log_Entry(ln_nbr,function_name,'Y',str(e),str(TOTAL_TIME).split('.')[0])\n        fs.write('Line 449 E|Error occured in api_tb|' + str(e) + '\\n')\n        fs_log.write('Line 449 E|Error occured in api_tb|' + str(e) + '\\n')\n        sw_outputs.append({\"python_output\": 'api_tb Completed with errors.' + str(e)})\n        # result_list1,errorlist2=collect_results(result_list1,errorlist2,results1,'E|Error occured in Search_Records|' + str(e))\n        # print 'Error in Search Records:' + str(e) + '\\n'\n        # raise Exception(\"Error updating and calculating total api bal for \" + search_engine1 + ' ' + str(e))\n        return (-1)\n\n\n# Obtain URLVoid API Call Balance and display on screen\n\ndef GetIdOfGroup(groupname):\n    groups = Group.find(name=groupname)\n    for g in groups:\n        if g.name == groupname:\n            # print g.name + ', ' + g.id\n            return g.id\n\n\ndef urlvoid_calc_total():\n    try:\n        function_name = 'urlvoid_calc_total'\n        BAL_DICT = {}\n        total = 0\n        max_count = 0\n        max_API_Key = ''\n\n        for rec in API_DICT:\n            if rec['Search_Engine'] == 'UrlVoid':\n                total = total + int(urlvoid_quota(rec[\"APIKey\"].strip()))\n                bal = int(urlvoid_quota(rec[\"APIKey\"].strip()))\n                BAL_DICT[rec[\"APIKey\"].strip()] = bal\n                if max_count < bal:\n                    max_count = bal\n                    max_API_Key = rec[\"APIKey\"].strip()\n                    # for rec in BAL_DICT:\n                    # fs.write(rec + ' '  + str(BAL_DICT[rec]) +  '\\n')\n        # fs.write('Total1:' + str(total) + '\\t max_API:' + max_API_Key + '\\t Max_Bal:' + str(max_count) + '\\n')\n\n\n        return (total, max_API_Key, max_count)\n\n    except Exception as e:\n        ln_nbr = '491'\n        TOTAL_TIME = (datetime.datetime.now() - s)\n        # Create_Error_Log_Entry(ln_nbr,function_name,'Y',str(e),str(TOTAL_TIME).split('.')[0])\n        message = 'Error calculating urlvoid_calc_total API Balance: ' + str(e)\n        fs_log.write('Line 495 ' + message + '\\n')\n        fs.write('Line 495 ' + message + '\\n')\n        return (message)\n\n\ndef urlvoid_quota(api_key):\n    try:\n        function_name = 'urlvoid_quota'\n        response = urllib.urlopen(\n            'http://api.urlvoid.com/{identifier}/{apikey}/stats/remained/'.format(identifier=Identifier,\n                                                                                  apikey=api_key)).read()\n        soup = BeautifulSoup(response, 'xml')\n        for rec in soup.find_all(name='queriesRemained'):\n            queries_remaining = str(rec).replace('<queriesRemained>', '').replace('</queriesRemained>', '')\n        # fs.write( 'Analyst\\'s new query balance is ' +   queries_remaining + ' out of 1000.')\n\n        return (int(queries_remaining))\n\n\n    except Exception as e:\n        # print ('Error Message: ' + str(e))\n        # fs.write('Error Message urlvoid_quota: ' + str(e) + '\\n')\n        ln_nbr = '516'\n        TOTAL_TIME = (datetime.datetime.now() - s)\n        # Create_Error_Log_Entry(ln_nbr,function_name,'Y',str(e),str(TOTAL_TIME).split('.')[0])\n        return ('Error Message: ' + str(e))\n\n\n'''\ntoday\ndef GetValueListValueId(app, field_name, field_value):\n    for v in GetFieldValuesList(app, field_name):\n        if v[u'name'] == unicode(field_value):\n            return v[u'id']\n\n\ndef GetFieldValuesList(app, field_name):\n    for f in app.fields:\n        if f[u'name'] == unicode(field_name):\n            return f[u'values']\n\n\ndef url_to_hyperlink(url, link_text):\n    prefix = '<a href=\"'\n    suffix = '\" target=\"_self\">' + link_text + '</a>'\n    hyperlink = prefix + url + suffix\n    return hyperlink\n'''\n\n\ndef add_records_as_reference(parent_app, record_id_to_add_ref_to, record_id_to_add_as_ref, reference_field_name):\n    try:\n        function_name = 'add_records_as_reference'\n        parent_app_id = parent_app.id\n        parent_record = Record.find(parent_app_id, record_id_to_add_ref_to)\n        ref_field_id = parent_app.field_id(reference_field_name)\n        try:\n            parent_record.values[ref_field_id].extend([record_id_to_add_as_ref])\n        except Exception:\n            parent_record.values[ref_field_id] = [record_id_to_add_as_ref]\n        parent_record.update()\n    except Exception as e:\n        ln_nbr = '553'\n        TOTAL_TIME = (datetime.datetime.now() - s)\n        # Create_Error_Log_Entry(ln_nbr,function_name,'Y',str(e),str(TOTAL_TIME).split('.')[0])\n        print(\"Error in add_records_as_reference(). ErrorMsg: \" + str(e))\n        fs_log.write(\"Line 557 Error in add_records_as_reference(). ErrorMsg: \" + str(e) + '\\n')\n        fs.write(\"Line 557 Error in add_records_as_reference(). ErrorMsg: \" + str(e) + '\\n')\n\n\ndef get_sec_event_link(parent_app, parent_record, host, parent_app_id):\n    t_field_ID = parent_app.field_id(\"Tracking Id\")\n    parent_record_tracking_id = parent_record.values[t_field_ID]\n\n    return url_to_hyperlink(\n        \"https://{host}/record/{parent_app_id}/{parent_record_id}\".format(host=host,\n                                                                          parent_app_id=str(parent_app_id),\n                                                                          parent_record_id=str(\n                                                                              parent_record.id)),\n        str(parent_record_tracking_id))\n\n\ndef rest2(customer_name):\n    try:\n        # fs=open('C:/test/restrict.txt','w')\n        if customer_name == '':\n            customer_name = 'SL-MSS'\n        fs.write('Customer Name:' + customer_name + '\\n')\n\n        app_id = \"583f29e49aee7c0c2044c5bb\"  # The application that you want to restrict records\n        GROUP_FIELD_NAME = customer_name  # sw_context.inputs[\"GROUPFIELDNAME\"] #Group field that holds the group to restrict records\n        ADMIN_GROUP_NAME = \"SL-Admins\"  # the admin group that will have access to all records\n        MSS_GROUP_NAME = \"SL-MSS\"\n        record_id = sw_context_config['RecordId']\n        record = Record.find(app_id, record_id)\n        group = next(Group.find(name=GROUP_FIELD_NAME))\n        admin_group = next(Group.find(name=ADMIN_GROUP_NAME))\n        mss_group = next(Group.find(name=MSS_GROUP_NAME))\n\n        # fs.write('group:' + str(GROUP_FIELD_NAME) + '\\tGroupID:' + str(group) + '\\n')\n        record.restrict(group, mss_group, admin_group)\n        # record.save()\n\n    except Exception as e:\n        fs.write('Error occurred:' + str(e) + '\\n')\n        fs_log = open(r'c:\\test\\Step_2_Error_Log.txt', 'a')\n        fs_log.write(str(alarm_id) + '\\n' + str(date_display) + ' Error Restricting Record \\n' + str(e) + '\\n')\n        fs_log.close()\n\n\ndef create_record(sec_events_app_ID, alarms_app_ID, child_record_id, **kwargs):\n    # fs.write('Line 430 create_record: Parent_App_Name:' + Parent_App_Name + ' Child_App_Name:' + Child_App_Name + ' child_record_id:' + child_record_id + '\\n')\n    try:\n\n        if timeprofile_switch != 'Off':\n            f.write(\"\\r\\n[{}] enter \\\"create_record\\\" method ~line 588\".format(datetime.datetime.now()))\n        parent_app = App.find(app_id=sec_events_app_ID)\n        base_event_deets = kwargs[\"base_event_deets\"]\n        empty_base_event_field_text = \"None\"\n        new_security_record_id = None\n\n        # if \"Parent Record\" in the security Events... mark it as so. Check that checkbox\n        if (kwargs[\"is_parent\"] == \"yes\"):\n            # make this new record the parent record\n\n            function_name = 'create_record'\n            if timeprofile_switch != 'Off':\n                f.write(\"\\r\\n[{}] [IS Parent] enter ~line 596\".format(datetime.datetime.now()))\n\n            # Create record in parent app\n            parent_record = Record.new_for(sec_events_app_ID)\n\n\n\n            # fs.write('line 439 parent_app_id:' + str(parent_app_id) + 'parent_record:' +  str(parent_record) + '\\n')\n\n            #customer_name = kwargs[\"customer_name\"]\n            # customer_name='M5'\n            customer = next(Group.find(name=customer_name))\n\n            customer_group_id = customer.id\n            # unhid this field\n\n            # fs.write('line 446 customer_name:' + str(customer_name) + 'customer_group_id:' +  str(customer_group_id) + '\\n')\n            \n            record_ID = parent_app.field_id(\"SIEM ID\")\n            parent_record.values[record_ID] = kwargs[\"siemid\"]\n\n            \n            record_ID = parent_app.field_id(\"Alarm Date Time Stamp\")\n            parent_record.values[record_ID] = kwargs[\"alarm_date\"]\n            \n            \n            # fs.write('line 453 record_ID:' + str(record_ID) + 'parent_record.values[record_ID] :' +  str(parent_record.values[record_ID] ) + '\\n')\n            # SearchEngine='URLvoid'\n            record_ID = parent_app.field_id(\"URLVoid API Call Balance\")\n            parent_record.values[record_ID] = str(kwargs[\"urlvoid_bal\"])\n\n            # SearchEngine='Malwares'\n            record_ID = parent_app.field_id(\"Malwares Balance\")\n            parent_record.values[record_ID] = str(kwargs[\"malwares_bal\"])\n\n            # SearchEngine='VirusTotal'\n            record_ID = parent_app.field_id(\"VirusTotal Balance\")\n            parent_record.values[record_ID] = str(kwargs[\"virustotal_bal\"])\n            \n\n            record_ID = parent_app.field_id(\"Signature Name\")\n            parent_record.values[record_ID] = str(kwargs[\"siem_rule_name\"])\n            \n            # fs.write('line 471 record_ID:' + str(record_ID) + 'parent_record.values[record_ID] :' +  str(parent_record.values[record_ID] ) + '\\n')\n            # fs.write('line 472 customer_name:' + str(kwargs[\"customer_name\"]) + '\\n')\n            # fs.write('line 473 customer_name id:' + str(next(Group.find(name=customer_name)).id) + '\\n')\n\n            \n            # fs.write('line 475 group_id:' + str(group_id) + '\\n')\n            '''\n            #June 22, 2017 - Changed by Joel\n            with open(\"c:\\\\temp\\\\raw4.txt\", \"w+\") as f3:\n                f3.write(str(group_id))\n                f3.write(str(kwargs[\"customer_name\"]))\n            '''\n            # fs.write('Line 481 Group_id:' + str(group_id) + '\\n')\n            \n            group_id = next(Group.find(name=sw_context.inputs[\"customer_name\"])).id\n            parent_record.values[parent_app.field_id('Customer Name')] = {\n                '$type': 'Core.Models.Utilities.UserGroupSelection, Core',\n                'id': group_id,\n                'name': str(kwargs[\"customer_name\"])\n            }\n            \n            # fs.write('Line 489 Customer Name:' + str(parent_record.values[parent_app.field_id('Customer Name')]) + '\\n')\n            '''\n            users = User.find(name=u_name)  # apiuser\n            for i in users:\n                user_id = i.id\n\n            #user_id = next(Users.find(name='Joel Laufer')).id\n            parent_record.values[parent_app.field_id('Initial Investigator')] = {\n                '$type': 'Core.Models.Utilities.UserGroupSelection, Core',\n                'id': user_id,\n                'name': u_name\n            }\n            '''\n            \n\n\n            # record_ID = parent_app.field_id(\"Customer Name (Temp)\")\n            # parent_record.values[record_ID] = kwargs[\"customer_name\"]\n            # record_ID = parent_app.field_id(\"Submitter\")\n            # parent_record.values[record_ID] = next(User.find(name=Client.default.username), None)\n            record_ID = parent_app.field_id(\"Times Reopened\")\n            parent_record.values[record_ID] = 0\n\n            record_ID = parent_app.field_id(\"Action\")\n            parent_record.values[record_ID] = kwargs[\"action\"]\n            record_ID = parent_app.field_id(\"Category\")\n            parent_record.values[record_ID] = kwargs[\"category\"]\n\n            record_ID = parent_app.field_id(\"Signature ID\")\n            parent_record.values[record_ID] = kwargs[\"signature_id\"]\n            record_ID = parent_app.field_id(\"Source IP\")\n            parent_record.values[record_ID] = kwargs[\"sip\"]\n            record_ID = parent_app.field_id(\"Destination IP\")\n            parent_record.values[record_ID] = kwargs[\"dip\"]\n            record_ID = parent_app.field_id(\"Source Port\")\n            parent_record.values[record_ID] = str(kwargs[\"sport\"])\n            record_ID = parent_app.field_id(\"Destination Port\")\n            parent_record.values[record_ID] = str(kwargs[\"dport\"])\n            record_ID = parent_app.field_id(\"Source Geo Location\")\n            parent_record.values[record_ID] = kwargs[\"sgeo\"]\n            record_ID = parent_app.field_id(\"Destination Geo Location\")\n            parent_record.values[record_ID] = kwargs[\"dgeo\"]\n            record_ID = parent_app.field_id(\"Log Source Name\")\n            parent_record.values[record_ID] = kwargs[\"log_source_name\"]\n            # populate base event details in the security event record (in either parent or child. If child, update parent)\n\n            record_ID = parent_app.field_id(\"BE Source IP's\")\n            parent_record.values[record_ID] = str(\", \".join(list(set(base_event_deets[\"SrcIP\"])))) if str(\n                \", \".join(list(set(base_event_deets[\"SrcIP\"])))) is not '' else empty_base_event_field_text\n            record_ID = parent_app.field_id(\"BE Destination IP's\")\n            parent_record.values[record_ID] = str(\", \".join(list(set(base_event_deets[\"DstIP\"])))) if str(\n                \", \".join(list(set(base_event_deets[\"DstIP\"])))) is not '' else empty_base_event_field_text\n            record_ID = parent_app.field_id(\"BE File Names\")\n            parent_record.values[record_ID] = str(\", \".join(list(set(base_event_deets[\"Filename\"])))) if str(\n                \", \".join(list(set(base_event_deets[\"Filename\"])))) is not '' else empty_base_event_field_text\n            record_ID = parent_app.field_id(\"BE File Hashes\")\n            parent_record.values[record_ID] = str(\", \".join(list(set(base_event_deets[\"File_Hash\"])))) if str(\n                \", \".join(list(set(base_event_deets[\"File_Hash\"])))) is not '' else empty_base_event_field_text\n            record_ID = parent_app.field_id(\"BE Urls\")\n            parent_record.values[record_ID] = str(\", \".join(list(set(base_event_deets[\"URL\"])))) if str(\n                \", \".join(list(set(base_event_deets[\"URL\"])))) is not '' else empty_base_event_field_text\n            record_ID = parent_app.field_id(\"BE Source Domains\")\n            parent_record.values[record_ID] = str(\", \".join(list(set(base_event_deets[\"Source_Domain\"])))) if str(\n                \", \".join(list(set(base_event_deets[\"Source_Domain\"])))) is not '' else empty_base_event_field_text\n            record_ID = parent_app.field_id(\"BE Destination Domains\")\n            parent_record.values[record_ID] = str(\", \".join(list(set(base_event_deets[\"Destination_Domain\"])))) if str(\n                \", \".join(list(set(base_event_deets[\"Destination_Domain\"])))) is not '' else empty_base_event_field_text\n            record_ID = parent_app.field_id(\"BE Threat Names\")\n            parent_record.values[record_ID] = str(\", \".join(list(set(base_event_deets[\"Threat_Name\"])))) if str(\n                \", \".join(list(set(base_event_deets[\"Threat_Name\"])))) is not '' else empty_base_event_field_text\n            record_ID = parent_app.field_id(\"Count of Base Events\")\n            parent_record.values[record_ID] = len(list(set(base_event_deets[\"recordids\"])))\n\n            record_ID = parent_app.field_id(\"Original Alarm ID\")\n            # fs.write('Line 537 Record_ID:' + str(record_ID) + '\\n')\n            # Get trackingId of child app\n            child_app = App.find(app_id=alarms_app_ID)\n            child_app_id = child_app.id\n            child_record = Record.find(child_app_id, child_record_id)\n            t_field_ID = child_app.field_id(\"Tracking Id\")\n            child_record_tracking_id = child_record.values[t_field_ID]\n\n            parent_record.values[record_ID] = url_to_hyperlink(\n                \"https://{host}/record/{child_app_id}/{child_record_id}\".format(host=host,\n                                                                                child_app_id=str(child_app_id),\n                                                                                child_record_id=str(child_record_id)),\n                str(child_record_tracking_id))\n            \n            # insert record\n            # fs.write('Line 551 -before save ' + '\\n')\n            parent_record.save()\n            new_security_record_id = parent_record.id\n            # rest(str(kwargs[\"customer_name\"]), sec_events_app_ID, new_parent_record_id)\n\n\n            Record.add_reference(sec_events_app_ID, new_security_record_id,\n                                 parent_app.field_id(kwargs[\"sec_event_add_alarms_ref_field_name\"]), [child_record_id])\n\n            # fs.write('Line 553 -after save ' + '\\n')\n\n            # get parent app Tracking Id\n\n            link_to_parent_record = get_sec_event_link(parent_app, parent_record, host, sec_events_app_ID)\n\n        else:\n\n            # we didn't create a new security event record. Update the security event record we found with details\n            if timeprofile_switch != 'Off':\n                f.write(\n                    \"\\r\\n[{}] IS NOT PARENT (link our newly created non-parent Security Event record to the parent Security Event record) ~line 576\".format(\n                        datetime.datetime.now()))\n            # Record.add_reference(parent_app_id, kwargs[\"master_record_id\"], parent_app.field_id(kwargs[\"sec_event_reference_field_name\"]), [parent_record.id])\n            # add_records_as_reference(parent_app, kwargs[\"master_record_id\"], parent_record.id,kwargs[\"sec_event_reference_field_name\"])\n            # link our newly created non-parent Security Event record to the Alarm record\n            if timeprofile_switch != 'Off':\n                f.write(\n                    \"\\r\\n[{}] IS NOT PARENT (link our newly created non-parent Security Event record to the Alarm record) ~line 580\".format(\n                        datetime.datetime.now()))\n\n            Record.add_reference(sec_events_app_ID, kwargs[\"master_record_id\"],\n                                 parent_app.field_id(kwargs[\"sec_event_add_alarms_ref_field_name\"]), [child_record_id])\n\n            # Update Parent sec event record's base event info\n            # In the parent sec event record, query all the base event fileds. Add their values to the appropriate base_event_deets[] lists\n            # then set the parent sec event record's base event fields equal to the uniques of base_event_deets[]\n            def update_parent_sec_event_record(parent_sec_record, sec_event_record_base_event_field_name,\n                                               base_event_list,\n                                               empty_base_event_field_text):\n                parent_field_val = \"\"\n                try:\n                    parent_field_val = parent_sec_record.values[\n                        parent_app.field_id(sec_event_record_base_event_field_name)]\n                except Exception as e:\n                    # This means the parent record has a null value for the specified sec_event_record_base_event_field_name field\n                    parent_field_val = empty_base_event_field_text\n                temp_list = parent_field_val.replace(\" \", \"\").split(\n                    \",\") if parent_field_val != empty_base_event_field_text else []\n                base_event_list.extend(temp_list)\n                csv_deduped = str(\", \".join(list(set(base_event_list))))\n                parent_sec_record.values[\n                    parent_app.field_id(sec_event_record_base_event_field_name)] = csv_deduped if csv_deduped is not '' \\\n                    else empty_base_event_field_text\n\n                return parent_sec_record\n\n            if timeprofile_switch != 'Off':\n                f.write(\n                    \"\\r\\n[{}] IS NOT PARENT ([START] updating parent record with unique base event info) ~line 599\".format(\n                        datetime.datetime.now()))\n            parent_sec_record = Record.find(sec_events_app_ID, kwargs[\"master_record_id\"])\n\n            if timeprofile_switch != 'Off':\n                f.write(\n                    \"\\r\\n[{}] IS NOT PARENT ([START] found Record) ~line 601\".format(\n                        datetime.datetime.now()))\n\n            parent_sec_record = update_parent_sec_event_record(parent_sec_record, \"BE Source IP's\",\n                                                               base_event_deets[\"SrcIP\"], empty_base_event_field_text)\n            parent_sec_record = update_parent_sec_event_record(parent_sec_record, \"BE Destination IP's\",\n                                                               base_event_deets[\"DstIP\"], empty_base_event_field_text)\n            parent_sec_record = update_parent_sec_event_record(parent_sec_record, \"BE File Names\",\n                                                               base_event_deets[\"Filename\"],\n                                                               empty_base_event_field_text)\n            parent_sec_record = update_parent_sec_event_record(parent_sec_record, \"BE File Hashes\",\n                                                               base_event_deets[\"File_Hash\"],\n                                                               empty_base_event_field_text)\n            parent_sec_record = update_parent_sec_event_record(parent_sec_record, \"BE Urls\", base_event_deets[\"URL\"],\n                                                               empty_base_event_field_text)\n            parent_sec_record = update_parent_sec_event_record(parent_sec_record, \"BE Source Domains\",\n                                                               base_event_deets[\"Source_Domain\"],\n                                                               empty_base_event_field_text)\n            parent_sec_record = update_parent_sec_event_record(parent_sec_record, \"BE Destination Domains\",\n                                                               base_event_deets[\"Destination_Domain\"],\n                                                               empty_base_event_field_text)\n            parent_sec_record = update_parent_sec_event_record(parent_sec_record, \"BE Threat Names\",\n                                                               base_event_deets[\"Threat_Name\"],\n                                                               empty_base_event_field_text)\n            record_ID = parent_app.field_id(\"Count of Base Events\")\n            parent_sec_record.values[record_ID] = len(list(set(base_event_deets[\"recordids\"])))\n            # fs.write('Line 631- before save \\n')\n            field_ID = parent_app.field_id(\"Times Reopened\")\n            times_reopened = parent_sec_record.values[field_ID]\n            times_reopened = times_reopened + kwargs[\"reopened_counter\"]\n            parent_sec_record.values[field_ID] = times_reopened\n            try:\n                parent_sec_record.save()\n            except Exception as e:\n                sw_outputs.append({\"python_output\": 'Line 459.' + str(e)})\n\n            link_to_parent_record = get_sec_event_link(parent_app, parent_sec_record, host, sec_events_app_ID)\n\n            if timeprofile_switch != 'Off':\n                f.write(\n                    \"\\r\\n[{}] IS NOT PARENT ([DONE] updating parent record with unique base event info) ~line 621\".format(\n                        datetime.datetime.now()))\n\n        # link the Alarm Record to our newly created security event record (either parent or child, doesn't matter)\n        #### Changed on 06/15/17####\n        default_template_name = 'Default Tier 1 Investigation'\n        default_template_rec_id = find_template_id(default_template_name)\n        # default_template_rec_id = '58c188dc9aee7c1214a4e796'\n        # fs.write('default_template_rec_id=' + default_template_rec_id + '\\n')\n\n        # add_records_as_reference(parent_app, parent_record.id, child_record_id,\n        #                         kwargs[\"sec_event_add_alarms_ref_field_name\"])\n\n        # matching_template_id=find_template_id(default_template_name)\n        if timeprofile_switch == 'On':\n            f.write(\"\\r\\n[{}] Begin attaching Default Task Template ~line 613\".format(datetime.datetime.now()))\n        # default_template_rec_id='58c188dc9aee7c1214a4e796'\n        # add_records_as_reference(parent_app, parent_record.id, \"58c188dc9aee7c1214a4e796\", \"Default Task Template\")\n        # add_records_as_reference(parent_app, parent_record.id, default_template_rec_id, \"Tasks\")\n        if timeprofile_switch == 'On':\n            f.write(\"\\r\\n[{}] End attaching Default Task Template ~line 626\".format(datetime.datetime.now()))\n            f.write(\"\\r\\n[{}] Begin attaching Other Task Template ~line 613\".format(datetime.datetime.now()))\n\n        # Find other templates matching left of '-' for SIEM_RULE\n        ###########################################################\n        # 1. Get substring to right of hyphen\n\n        other_template_rec_id = str(kwargs[\"siem_rule_name\"]).split(\"-\")[1].replace(\"\\'\", \"\").replace('\\t', '').replace(\n            '\\n', '')\n\n        fs_log.write('Line 668 other_template_rec_id: ' + other_template_rec_id + '\\n')\n\n        # other_template_rec_id='ExcessivelyHighBytesOut'\n\n        # 2. Get record id for task using SIEM_RULE above\n        #    Validate the record, then add as reference...\n        if (other_template_rec_id != '' and other_template_rec_id != 'None' and other_template_rec_id != None):\n            matching_template_id = str(find_template_id(other_template_rec_id))\n\n            # fs.write('Line 679 Matching Rule ID: ' + matching_template_id + '\\n')\n            # 3. Add reference to template\n\n            # add_records_as_reference(parent_app, parent_record.id, matching_template_id,\n            #                         \"Additional Rule Task Template\")\n            # add_records_as_reference(parent_app, parent_record.id, matching_template_id, \"Default Task Template\")\n        if timeprofile_switch == 'On':\n            f.write(\"\\r\\n[{}] End attaching Other Task Template ~line 626\".format(datetime.datetime.now()))\n\n        # link the template default record to our newly created security event record (either parent or child, doesn't matter).\n        # add_records_as_reference(parent_app, parent_record.id, child_record_id, kwargs[\"\"]\n        if timeprofile_switch == 'On':\n            f.write(\"\\r\\n[{}] Return from create_record ~line 641\".format(datetime.datetime.now()))\n\n        sw_outputs.append({\"url_parent_record\": link_to_parent_record})\n\n        return new_security_record_id\n\n    except Exception as e:\n        ln_nbr = '845'\n        TOTAL_TIME = (datetime.datetime.now() - s)\n        # Create_Error_Log_Entry(ln_nbr,function_name,'Y',str(e),str(TOTAL_TIME).split('.')[0])\n        fs_log.write('line 848 Error creating record:' + str(e) + '\\n')\n        fs.write('line 848 Error creating record:' + str(e) + '\\n')\n\n\n###############\n# ENTRY POINT #\n###############\n\nif check_failed_job == 'On':\n    x = 1 / 0\n\ntry:\n    py_charm()\n    function_name = 'Main'\n    if timeprofile_switch == 'On':\n        f.write(\"\\r\\n[{}] Entry Point ~line 731\".format(datetime.datetime.now()))\n    sec_events_app_name = \"Security Events\"\n    alarms_app_name = \"Alarms\"\n    base_events_app_name = \"Base Events\"\n    sec_events_app_ID = find_app_id(sec_events_app_name)  # \"58410f1c9aee7c10e0f9afa8\"\n    alarms_app_ID = find_app_id(alarms_app_name)  # \"583f29e49aee7c0c2044c5bb\"\n    base_events_app_ID = find_app_id(base_events_app_name)  # \"584105309aee7c01ecd74dfd\"\n    # base_event_fields_to_capture = [\"SrcIP\", \"DstIP\", \"Filename\", \"File_Hash\", \"Threat_Name\", \"URL\", \"Source_Domain\", \"Destination_Domain\"]  # append field names from the Base Events here. They will get sent to the sec event.\n\n    # First, cycle through each reference in the Base Events application\n    # grab the recordids of all referenced fields\n    # grab the field values of all fields listed in the variable base_event_fields_to_capture (few lines above)\n\n    alarms_app = App.find(app_id=alarms_app_ID)\n    ##### put the reference field name in to get the reference field id\n    base_events_reference_fieldid = alarms_app.field_id(\"Base Events\")\n    # Get the list of referenced recordids (the reference field itself just hold a list of the recordids that are being referenced)\n    alarm_record = Record.find(alarms_app_ID, current_alarm_recordid)\n    base_event_deets = {\"SrcIP\": [], \"DstIP\": [], \"Filename\": [], \"File_Hash\": [], \"Threat_Name\": [], \"URL\": [],\n                        \"Source_Domain\": [], \"Destination_Domain\": [], \"recordids\": []}\n    try:\n        references = alarm_record.values[base_events_reference_fieldid]\n        # Now find the referenced records in the child app\n        ##### grab the child appid from the URL when viewing in App Builder\n        base_events_app = App.find(app_id=base_events_app_ID)\n\n        ##### get the fieldids of the fields you want to save the values from (in the base event)\n        base_event_fields = []\n        for item in base_event_deets:\n            base_event_fields.append({\"field_id\": base_events_app.field_id(item), \"field_name\": item})\n        # cycle through the list of records in your ref field\n        for child_recordid in references:\n            # for each reference/record, cycle through the list of fields you want save the values of\n            child_record = Record.find(base_events_app_ID, child_recordid)\n            for field in base_event_fields:\n                # child_record = Record.find(field[\"field_id\"], child_recordid)\n                try:\n                    v = str(child_record.values[field[\"field_id\"]])\n                    if not (v == '' or v is None or v == \"None\" or v == \"Not Available\"):\n                        base_event_deets[field[\"field_name\"]].append(child_record.values[field[\"field_id\"]])\n                except Exception as e:\n                    # this is necessary incase any new base event fields are added to existing records\n                    pass\n            base_event_deets[\"recordids\"].append(child_recordid)\n    except Exception as e:\n        # te('Exception from first try:' + str(e) + '\\n')\n        # There are no base event references in the alarms app\n        pass\n\n    if timeprofile_switch == 'On':\n        f.write(\"\\r\\n[{}] After grabbing base event deets ~line 778\".format(datetime.datetime.now()))\n    # fs.write('Line 707 \\n')\n    # Example of base_event_deets\n    # base_event_deets = {'DstIP': [u'37.58.85.37', u'37.58.85.37', u'37.58.85.37', u'37.58.85.37', u'37.58.85.37'], 'Destination_Domain': [u'sl-reverse.com', u'sl-reverse.com', u'sl-reverse.com', u'sl-reverse.com', u'sl-reverse.com'], 'URL': [u'http://c.fqtag.com/tag/implement-r.js?org=tH4C4EXU8ebrUb4uxUve&p=FSWITCH18&a=177&cmp=80&rd=http%3A%2F%2Fwww.dailymail.co.uk&rt=display&sl=1', u'http://c.fqtag.com/tag/implement-r.js?org=tH4C4EXU8ebrUb4uxUve&p=FSWITCH18&a=169&cmp=80&rd=http%3A%2F%2Fwww.dailymail.co.uk&rt=display&sl=1', u'http://c.fqtag.com/tag/implement-r.js?org=tH4C4EXU8ebrUb4uxUve&p=FSWITCH18&a=169&cmp=80&rd=http%3A%2F%2Fwww.dailymail.co.uk&rt=display&sl=1', u'http://c.fqtag.com/tag/implement-r.js?org=tH4C4EXU8ebrUb4uxUve&p=FSWITCH18&a=172&cmp=80&rd=http%3A%2F%2Fwww.dailymail.co.uk&rt=display&sl=1', u'http://c.fqtag.com/tag/implement-r.js?org=tH4C4EXU8ebrUb4uxUve&p=FSWITCH18&a=177&cmp=80&rd=http%3A%2F%2Fwww.dailymail.co.uk&rt=display&sl=1'], 'Source_Domain': [], 'Filename': [], 'File_Hash': [], 'Threat_Name': [], 'SrcIP': [u'10.110.22.212', u'10.110.22.212', u'10.110.22.212', u'10.110.22.212', u'10.110.22.212'], 'recordids': [u'58add5279aee7c1514a8cc31', u'58add5289aee7c1514a8cd41', u'58add5289aee7c1514a8ce4d', u'58add5299aee7c1514a8cf60', u'58add52a9aee7c1514a8d06e']}\n\n    # Next, on record save look at the \"Signature Name\" field, capture that value.\n    # Look through all records in the app\n    # for each Master record, see if the IP already exists\n    # If so, add as ref\n    # If not, make it the master record.\n    user_id = \"\"  # used to create the temp report under\n\n    field_value_1_name = \"Signature Name\"\n    field_value_1_value = sw_context.inputs['siem_rule_name']\n    field_value_2_name = \"Customer Name\"\n    field_value_2_value = sw_context.inputs['customer_name']\n    field_value_3_name = \"Source IP\"\n    field_value_3_value = sw_context.inputs['sip']\n    field_value_4_name = \"Destination IP\"\n    field_value_4_value = sw_context.inputs['dip']\n    # sec_event_reference_field_name = \"Security Events\"\n    sec_event_add_alarms_ref_field_name = \"Additional Alarms\"\n    tasK_add_ref_field_name = 'Reference'\n    reopened_counter = 0  # used to keep track of how many times a security event record is reopened\n\n    '''\n    #################################################################################################\n    #  Optional Logical Switch for turning on/off Search Engine Functionality\n    #          Search_Engine_Switch!='Off' set in variable section at line 82.\n    #################################################################################################\n    '''\n\n    if Search_Engine_Switch != 'Off':\n        ####################################\n        # Find URLVoid Balance\n        ####################################\n        try:\n            total, max_API_Key, max_count = urlvoid_calc_total()\n            urlvoid_balance = total  # use_api_value_list[0]\n            # fs.write('Line 622\\n' )\n        except Exception as e:\n            # fs.write('Error calculating URLVoid Max, Total, and APIKey' + str(e))\n            urlvoid_balance = -1\n            error_message = 'Error calculating URLVoid Max, Total, and APIKey' + str(\n                e)  # urlvoid_balance + ' ' + str(e) + '\\n' + sw_context.inputs['python_message'].strip()\n            sw_outputs.append({\"python_message\": error_message})\n\n        ####################################\n        # Find Malwares Balance\n        ####################################\n        try:\n            malwares_balance = api_tb('BAL', 'Malware', '')\n            # fs.write('Line 634 Malwares Balance is:' + str(malwares_balance) + '\\n------------------------------------------------------------------------------------\\n')\n        except Exception as e:\n            # fs.write('Error calculating malwares_bal Max, Total, and APIKey' + str(e) + '\\n')\n            malwares_balance = -1\n            error_message = 'Malwares bal Error:' + ' ' + str(e) + '\\n' + sw_context.inputs['python_message'].strip()\n            sw_outputs.append({\"python_message\": error_message})\n            # malwares_bal = 'Error:Unknown'\n\n        ####################################\n        # Find VirusTotal Balance\n        ####################################\n        try:\n            virustotal_balance = api_tb('BAL', 'VirusTotal', '')\n            fs_log.write('Line 825 VirusTotal Balance is:' + str(\n                virustotal_balance) + '\\n------------------------------------------------------------------------------------\\n')\n        except Exception as e:\n            fs_log.write('Line 827 Error calculating malwares_bal Max, Total, and APIKey' + str(e) + '\\n')\n            virustotal_balance = -1\n            error_message = 'VirusTotal Bal Error - ' + str(e) + '\\n' + sw_context.inputs['python_message'].strip()\n            sw_outputs.append({\"python_message\": error_message})\n            # malwares_bal = 'Error:Unknown'\n    else:\n        virustotal_balance = 0\n        malwares_balance = 0\n        urlvoid_balance = 0\n\n    users = User.find(name=sw_context.inputs['apiuser_user'])  # apiuser\n    for i in users:\n        user_id = i.id\n\n    if timeprofile_switch == 'On':\n        f.write(\"\\r\\n[{}] After search engines ~line 862\".format(datetime.datetime.now()))\n\n    master_record_id = \"\"\n    sec_events_app = App.find(app_id=sec_events_app_ID)\n\n    ################\n    # Report search for existing Master Record Search#\n    ################\n    report = Report.new_for(sec_events_app_ID, user_id, \"Master Record Search\")\n    from swimlane.core.resources import App\n    from swimlane.core.search.filtering import create_filter, EQ\n\n    linking_field_id_1 = sec_events_app.field_id(field_value_1_name)\n    linking_field_id_2 = sec_events_app.field_id(field_value_2_name)\n    group_id = GetIdOfGroup(field_value_2_value)\n    linking_field_id_3 = sec_events_app.field_id(field_value_3_name)\n    linking_field_id_4 = sec_events_app.field_id(field_value_4_name)\n    report.filters = [create_filter(linking_field_id_1, EQ, field_value_1_value),\n                      create_filter(linking_field_id_2, EQ, group_id),\n                      create_filter(linking_field_id_3, EQ, field_value_3_value),\n                      create_filter(linking_field_id_4, EQ, field_value_4_value)]\n    last_closed_date_field_id = sec_events_app.field_id(\"Last Closed Date\")\n    status_field_id = sec_events_app.field_id(\"Status\")\n    tracking = sec_events_app.field_id(\"Tracking Id\")\n    report.columns = [sec_events_app.field_id(\"Tracking Id\"), linking_field_id_1, linking_field_id_2,\n                      sec_events_app.field_id(\"Status\"), sec_events_app.field_id(\"Last Closed Date\")]\n    # report.update()\n    if timeprofile_switch == 'On':\n        f.write(\"\\r\\n[{}] Begin report search 896\".format(datetime.datetime.now()))\n    search = Search(report)\n    result = search.execute()\n\n    if timeprofile_switch != 'Off':\n        f.write(\"\\r\\n[{}] After report search&execute 901\".format(datetime.datetime.now()))\n\n\n    def create_record_as_parent():\n        ######################################\n        # Create a new Security Event record #\n        ######################################\n        # create_record(parent_app, child_app, child_record_id, siemid=test_val, customer_name=test_val, siem_rule_name=field_value_in_question, submitter=test_val, sec_event_add_alarms_ref_field_name=sec_event_add_alarms_ref_field_name, is_parent=\"yes\", master_check_box_field_name=master_check_box_field_name, checkbox_selection_field_id=checkbox_selection_field_id)\n        # create_record(\"Security Events\", \"Alarms\", child_record_id, siemid=sw_context.inputs[\"siemid\"], customer_name=sw_context.inputs[\"customer_name\"], submitter=test_val, signature_id=sw_context.inputs[\"signature_id\"], sip=sw_context.inputs[\"sip\"], dip=sw_context.inputs[\"dip\"], sport=sw_context.inputs[\"sport\"], dport=sw_context.inputs[\"dport\"], sgeo=sw_context.inputs[\"sgeo\"], dgeo=sw_context.inputs[\"dgeo\"], log_source_name=sw_context.inputs[\"log_source_name\"], siem_rule_name=sw_context.inputs[\"siem_rule_name\"], sec_event_add_alarms_ref_field_name=sec_event_add_alarms_ref_field_name, is_parent=\"yes\", master_check_box_field_name=master_check_box_field_name, checkbox_selection_field_id=checkbox_selection_field_id)\n        # fs.write('Line 834 \\n')\n        '''\n        fs.write('sec_event_add_alarms_ref_field_name=' + sec_event_add_alarms_ref_field_name + '\\n')\n\n        fs.write('Line 892 create_record_as_parent:' + 'current_alarm_recordid:' + current_alarm_recordid + '\\n')\n        fs.write('   siemid:' + sw_context.inputs[\"siemid\"] + '\\n')\n        fs.write('   urlvoid_bal:' + str(urlvoid_balance) + '\\n')\n        fs.write('   malwares_bal:' + str(malwares_balance) + '\\n')\n        fs.write('   virustotal_bal:' + str(virustotal_balance) + '\\n')\n        fs.write('   customer_name:' + (sw_context.inputs[\"customer_name\"]) + '\\n')\n        fs.write('   submitter:' + test_val + '\\n')\n        fs.write('   Signature_id:' + (sw_context.inputs[\"signature_id\"]) + '\\n')\n        fs.write('   sip:' + (sw_context.inputs[\"sip\"]) + '\\n')\n        fs.write('   dip:' + (sw_context.inputs[\"dip\"]) + '\\n')\n        fs.write('   sport:' + (sw_context.inputs[\"sport\"]) + '\\n')\n        fs.write('   dport:' + (sw_context.inputs[\"dport\"]) + '\\n')\n        fs.write('   sgeo:' +  (sw_context.inputs[\"sgeo\"]) + '\\n')\n        fs.write('   dgeo:' + (sw_context.inputs[\"dgeo\"]) + '\\n')\n        fs.write('   log_source_name:' + (sw_context.inputs[\"log_source_name\"]) + '\\n')\n        fs.write('   siem_rule_name:' + (sw_context.inputs[\"siem_rule_name\"]) + '\\n')\n        fs.write('   sec_event_add_alarms_ref_field_name:' + (sec_event_add_alarms_ref_field_name) + '\\n')\n        fs.write('   checkbox_selection_field_name:' + (checkbox_selection_field_name) + '\\n')\n        fs.write('   reopened_counter:' + str(reopened_counter) + '\\n')\n        fs.write('   is_parent:' + (\"yes\") + '\\n')\n        fs.write('   master_check_box_field_name:' + (master_check_box_field_name) + '\\n')\n        fs.write('   checkbox_selection_field_id:' + (checkbox_selection_field_id) + '\\n')\n        fs.write('   action:' + (sw_context.inputs['action_name']) + '\\n')\n        fs.write('   category:' + (sw_context.inputs['category']) + '\\n')\n        fs.write('   base_event_deets:' + str(base_event_deets) + '\\n')\n        '''\n\n        return create_record(sec_events_app_ID, \n                             alarms_app_ID, \n                             current_alarm_recordid,\n                             siemid=sw_context.inputs[\"siemid\"],\n                             alarm_date=sw_context.inputs['alarm_date'],\n                             urlvoid_bal=str(urlvoid_balance), \n                             malwares_bal=str(malwares_balance),\n                             virustotal_bal=str(virustotal_balance),\n                             customer_name=sw_context.inputs[\"customer_name\"], \n                             submitter=test_val,\n                             signature_id=sw_context.inputs[\"signature_id\"],\n                             sip=sw_context.inputs[\"sip\"], \n                             dip=sw_context.inputs[\"dip\"],\n                             sport=str(sw_context.inputs[\"sport\"]),\n                             dport=str(sw_context.inputs[\"dport\"]), \n                             sgeo=sw_context.inputs[\"sgeo\"],\n                             dgeo=sw_context.inputs[\"dgeo\"],\n                             log_source_name=sw_context.inputs[\"log_source_name\"],\n                             siem_rule_name=sw_context.inputs[\"siem_rule_name\"],\n                             sec_event_add_alarms_ref_field_name=sec_event_add_alarms_ref_field_name,\n                             # checkbox_selection_field_name=checkbox_selection_field_name,\n                             reopened_counter=reopened_counter, is_parent=\"yes\",\n                             # master_check_box_field_name=master_check_box_field_name,\n                             # checkbox_selection_field_id=checkbox_selection_field_id,\n                             action=sw_context.inputs['action_name'],\n                             category=sw_context.inputs['category'],\n                             base_event_deets=base_event_deets)\n\n\n    def update_sec_event_record(master_record_id):\n        ############################################################################################################\n        # Create new Security Event record. Don't mark it as Master.  add current Alarm record as reference to it. #\n        # Also add current alarm record to the master Security Event record  #\n        ############################################################################################################\n        # create_record(parent_app, child_app, child_record_id, siemid=test_val, customer_name=test_val, siem_rule_name=field_value_in_question, sec_event_add_alarms_ref_field_name=sec_event_add_alarms_ref_field_name, is_parent=\"no\", master_record_id=master_record_id, sec_event_reference_field_name=sec_event_reference_field_name)\n        # create_record(\"Security Events\", \"Alarms\", child_record_id, siemid=sw_context.inputs[\"siemid\"], customer_name=sw_context.inputs[\"customer_name\"], submitter=test_val, signature_id=sw_context.inputs[\"signature_id\"], sip=sw_context.inputs[\"sip\"], dip=sw_context.inputs[\"dip\"], sport=sw_context.inputs[\"sport\"], dport=sw_context.inputs[\"dport\"], sgeo=sw_context.inputs[\"sgeo\"], dgeo=sw_context.inputs[\"dgeo\"], log_source_name=sw_context.inputs[\"log_source_name\"], siem_rule_name=sw_context.inputs[\"siem_rule_name\"], sec_event_add_alarms_ref_field_name=sec_event_add_alarms_ref_field_name, is_parent=\"no\", master_record_id=master_record_id, sec_event_reference_field_name=sec_event_reference_field_name)\n        '''\n        fs.write('Line 862 \\n')\n\n        fs.write('Line 948 create_record_as_child:' + 'current_alarm_recordid:' + current_alarm_recordid + '\\n')\n        fs.write('   siemid:' + sw_context.inputs[\"siemid\"] + '\\n')\n        fs.write('   urlvoid_bal:' + str(urlvoid_balance) + '\\n')\n        fs.write('   malwares_bal:' + str(malwares_balance) + '\\n')\n        fs.write('   virustotal_bal:' + str(virustotal_balance) + '\\n')\n        fs.write('   customer_name:' + (sw_context.inputs[\"customer_name\"]) + '\\n')\n        fs.write('   submitter:' + test_val + '\\n')\n        fs.write('   Signature_id:' + (sw_context.inputs[\"signature_id\"]) + '\\n')\n        fs.write('   sip:' + (sw_context.inputs[\"sip\"]) + '\\n')\n        fs.write('   dip:' + (sw_context.inputs[\"dip\"]) + '\\n')\n        fs.write('   sport:' + (sw_context.inputs[\"sport\"]) + '\\n')\n        fs.write('   dport:' + (sw_context.inputs[\"dport\"]) + '\\n')\n        fs.write('   sgeo:' +  (sw_context.inputs[\"sgeo\"]) + '\\n')\n        fs.write('   dgeo:' + (sw_context.inputs[\"dgeo\"]) + '\\n')\n        fs.write('   log_source_name:' + (sw_context.inputs[\"log_source_name\"]) + '\\n')\n        fs.write('   siem_rule_name:' + (sw_context.inputs[\"siem_rule_name\"]) + '\\n')\n        fs.write('   sec_event_add_alarms_ref_field_name:' + (sec_event_add_alarms_ref_field_name) + '\\n')\n        fs.write('   checkbox_selection_field_name:' + (checkbox_selection_field_name) + '\\n')\n        fs.write('   reopened_counter:' + str(reopened_counter) + '\\n')\n        fs.write('   is_parent:' + (\"no\") + '\\n')\n        fs.write('   master_check_box_field_name:' + (master_check_box_field_name) + '\\n')\n        fs.write('   checkbox_selection_field_id:' + (checkbox_selection_field_id) + '\\n')\n        fs.write('   action:' + (sw_context.inputs['action_name']) + '\\n')\n        fs.write('   category:' + (sw_context.inputs['category']) + '\\n')\n        fs.write('   base_event_deets:' + str(base_event_deets) + '\\n')\n        '''\n        return create_record(sec_events_app_ID, \n                             alarms_app_ID, \n                             current_alarm_recordid,\n                             siemid=sw_context.inputs[\"siemid\"],\n                             alarm_date=sw_context.inputs['alarm_date'],\n                             urlvoid_bal=str(urlvoid_balance), \n                             malwares_bal=str(malwares_balance),\n                             virustotal_bal=str(virustotal_balance),\n                             customer_name=sw_context.inputs[\"customer_name\"], \n                             submitter=test_val,\n                             signature_id=sw_context.inputs[\"signature_id\"],\n                             sip=sw_context.inputs[\"sip\"],\n                             dip=str(sw_context.inputs[\"dip\"]),\n                             sport=str(sw_context.inputs[\"sport\"]),\n                             dport=str(sw_context.inputs[\"dport\"]), \n                             sgeo=sw_context.inputs[\"sgeo\"],\n                             dgeo=sw_context.inputs[\"dgeo\"],\n                             log_source_name=sw_context.inputs[\"log_source_name\"],\n                             siem_rule_name=sw_context.inputs[\"siem_rule_name\"],\n                             sec_event_add_alarms_ref_field_name=sec_event_add_alarms_ref_field_name,\n                             # checkbox_selection_field_name=checkbox_selection_field_name,\n                             reopened_counter=reopened_counter, is_parent=\"no\",\n                             master_record_id=master_record_id,\n                             # sec_event_reference_field_name=sec_event_reference_field_name,\n                             action=sw_context.inputs['action_name'],\n                             category=sw_context.inputs['category'],\n                             base_event_deets=base_event_deets)\n\n\n    # Set a VALUES LIST field in a record equal to a value\n    def set_record_status(App_ID, record_id, field_name, field_value):\n        # change status to \"Re-Opened\"\n        # fs.write('Line 998 \\n')\n        parent_app = App.find(app_id=App_ID)\n        value_id = GetValueListValueId(parent_app, field_name, field_value)\n        record = Record.find(parent_app.id, record_id)\n        field_ID = parent_app.field_id(\"Status\")\n        # record.values[field_ID] = value_id\n        record.values[field_ID] = {\n            '$type': 'Core.Models.Record.ValueSelection, Core',\n            'id': value_id,\n            'value': field_value\n        }\n        # fs.write('Line 1009 before save' + '\\n')\n        record.save()\n        # fs.write('Line 1011 after save' + '\\n')\n\n\n    # Search for Sec Event App with identical customer, signature, source IP, Dest IP & is parent record\n    # sort by tracking ID Descending\n    # Select top result\n    # IF top result if status = closed\n    #   IF Closed False Positive:\n    #     make this record parent\n    #   Else IF other closed values:\n    #     Check how long ago it was closed:\n    #       if closed > 1day : Make this record parent\n    #       if closed < 1day : Re-open parent record and add this record as child. Set child record status = closed-Child\n    # IF Not Closed: Make this record child & add to parent. Set child record status = closed-Child\n    if timeprofile_switch == 'On':\n        f.write(\"\\r\\n[{}] Enter Create parent/child record logic 1048\".format(datetime.datetime.now()))\n\n    if result.count > 0:\n\n        r = reversed(list(result.records))  # A generator that yields the Records for this page.\n\n        for i in r:\n            master_record_id = i.id\n\n            status = i.values[sec_events_app.field_id(\"Status\")][\"value\"]\n\n            # if the parent record we found was closed false poitive - don't touch it. Make this new security event a parent record\n            if status == \"Closed - False Positive\":\n                # fs.write('Line 1039 call to create_record_as_parent()\\n')\n                new_parent_record_id = create_record_as_parent()\n                set_record_status(sec_events_app_name, new_parent_record_id, \"Status\", \"Unassigned\")\n                # fs.write('Line 1042 after call to create_record_as_parent()\\n')\n\n            elif status in [\"Closed - Customer\", \"Closed - CR Created\", \"Closed - SR Created\", \"Closed - Inactivity\",\n                            \"Closed - Child\"]:\n                last_closed_date = i.values[sec_events_app.field_id(\"Last Closed Date\")]\n                closed_date = iso8601.parse_date(last_closed_date)\n                time_now = datetime.datetime.now(pytz.utc)\n                one_day_ago = time_now + datetime.timedelta(days=-1)\n                if closed_date > one_day_ago:\n                    # record that was found is less than 1 day old\n\n                    # re-open the found parent record\n                    set_record_status(sec_events_app_ID, master_record_id, \"Status\", \"Re-Opened\")\n                    reopened_counter = 1\n                    # create a new record, make it a child record. Link it to the parent\n                    child_record_id = update_sec_event_record(master_record_id)\n\n                    # close child (newly created) record\n                    set_record_status(sec_events_app_ID, child_record_id, \"Status\", \"Closed - Child\")\n                else:\n                    # record found is more than 1 days old\n                    # fs.write('Line 1062 before call to create record as parent\\n')\n                    new_parent_record_id = create_record_as_parent()\n                    set_record_status(sec_events_app_ID, new_parent_record_id, \"Status\", \"Unassigned\")\n                    \n\n                    # fs.write('line 544 after call to create record as parent\\n')\n            else:\n                # if the record that was found is not closed, attach this new record to it (mark the newly created record as child)\n                # fs.write('Line 550 create_record_as Child' + ' ' + master_record_id + '\\n')\n\n                new_parent_record_id = update_sec_event_record(master_record_id)\n                # set_record_status(sec_events_app_name, new_parent_record_id, \"Status\", \"Unassigned\")\n                # fs.write('Line 1073 post create child record\\n')\n            break\n\n    else:\n        # fs.write('Line 1077 Call to create record as parent\\n')\n        new_parent_record_id = create_record_as_parent()\n        set_record_status(sec_events_app_ID, new_parent_record_id, \"Status\", \"Unassigned\")\n        # fs.write('Line 1080 after parent save call\\n')\n    # fs.write('Line 964 \\n')\n    sw_outputs.append({\"reopened_counter\": reopened_counter})\n    # fs.close\n    #record.save()  # Changed on 09-06-17\n\n\n    if timeprofile_switch == 'On':\n        # f.write(\"\\r\\n[{}]\" + sw_context.inputs['action_name'] +\" TOTAL TIME Create Security Event={}\".format(datetime.datetime.now(), datetime.datetime.now() - START_TIME))\n        f.write(\"\\r\\n[{}] {}                 END.                  TOTAL_TIME=[{}]\".format(datetime.datetime.now(),\n                                                                                           sw_context.inputs[\n                                                                                               'action_name'], (\n                                                                                               datetime.datetime.now() - s)))\n        # f.close()\n\n    # fs_log.close()\n    sw_outputs.append({'se_creation_dt': date1})\n    fs.write('Alarm_Date:' + str(sw_context.inputs['alarm_date']) + '\\n')\n    sw_outputs.append({\"alarm_date\": sw_context.inputs['alarm_date']})\n    sw_outputs.append({'show_se_button': 'no'})\n\n    ###################################################################################\n    #  Restrict Records\n    ###################################################################################\n\n    if new_parent_record_id:\n        #restrictrec(customer_name, sec_events_app_ID,new_parent_record_id,fs_log1)\n        pass\n\n    function_name = 'Main'\n    ln_nbr = '1243'\n    TOTAL_TIME = (datetime.datetime.now() - s)\n    # Create_Error_Log_Entry(ln_nbr,function_name,'N',str(e),str(TOTAL_TIME).split('.')[0])\n    Create_Error_Log_Entry(prg_name, ln_nbr, function_name, 'N', '', str(TOTAL_TIME).split('.')[0], alarm_id, '',\n                           action_name, fs, customer_name, '', sw_context.inputs['siem_rule_name'], '')\n\n    # fs.close()\n\nexcept Exception as e:\n    restrictrec(customer_name, sec_events_app_ID, new_parent_record_id, fs_log1)\n    sw_outputs.append({\"python_output\": 'Main Completed with errors.' + str(e)})\n    fs_log.write('Line 1252 Main Completed with errors.' + str(e) + '\\n')\n\n    function_name = 'Main'\n    ln_nbr = '1254'\n    TOTAL_TIME = (datetime.datetime.now() - s)\n    # Create_Error_Log_Entry(ln_nbr,function_name,'Y',str(e),str(TOTAL_TIME).split('.')[0])\n    Create_Error_Log_Entry(prg_name, ln_nbr, function_name, 'Y', str(e), str(TOTAL_TIME).split('.')[0], alarm_id, '',\n                           action_name, fs, customer_name, '', sw_context.inputs['siem_rule_name'], '')\n    fs.write('Line 1252 Main Completed with errors.' + str(e) + '\\n')\n    # fs.close()\n    if timeprofile_switch == 'On':\n        # f.write(\"\\r\\n[{}]\" + sw_context.inputs['action_name'] + \" Error - TOTAL TIME Create Security Event={}\".format(datetime.datetime.now(), datetime.datetime.now() - START_TIME))\n        f.write(\"\\r\\n[{}] {}                 Error.                  TOTAL_TIME=[{}]\".format(datetime.datetime.now(),\n                                                                                             sw_context.inputs[\n                                                                                                 'action_name'], (\n                                                                                                 datetime.datetime.now() - s)))\n        # f.close()\n    fs_log.close()\n    raise Exception(\"Error in Main: \" + str(e))\n"
    }, 
    "inputMapping": [
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "a1ba6", 
            "key": "siemid", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "a0o1n", 
            "key": "signature_id", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "a76se", 
            "key": "sip", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "a8nha", 
            "key": "dip", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "aiksm", 
            "key": "sport", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "avra6", 
            "key": "dport", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "axmqr", 
            "key": "sgeo", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "a4e6b", 
            "key": "dgeo", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "axot4", 
            "key": "log_source_name", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "ajzk9", 
            "key": "siem_rule_name", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "aygw6", 
            "key": "customer_name", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "literal", 
            "value": "On", 
            "key": "timeprofile_switch", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "literal", 
            "value": "Off", 
            "key": "Search_Engine_Switch", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "a4afj", 
            "key": "action_name", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "aqktf", 
            "key": "device_action", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "axb5v", 
            "key": "category", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "literal", 
            "value": "Off", 
            "key": "check_failed_job", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "583f29e49aee7c0c2044c5bd", 
            "key": "alarm_id", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "a81j7", 
            "key": "alarm_date", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "ac3tf", 
            "key": "se_generate", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "record", 
            "value": "azeb0", 
            "key": "full_message", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "credentials", 
            "value": "apiuser_user", 
            "key": "apiuser_user", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "credentials", 
            "value": "apiuser_credential", 
            "key": "apiuser_credential", 
            "addMissing": false
        }, 
        {
            "$type": "Core.Models.Integrations.Descriptors.Mapping, Core", 
            "type": "literal", 
            "value": "On", 
            "key": "charm_flag", 
            "addMissing": false
        }
    ], 
    "applicationId": "aYvGaX9lTbPM4", 
    "id": "aRhMHnAtE_LdQ"
}